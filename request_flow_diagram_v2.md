# è¯¾ç¨‹ææ–™RAGç³»ç»Ÿ - è¯·æ±‚å¤„ç†æµç¨‹å›¾ V2.0

## åŒæ¨¡å‹æ™ºèƒ½è·¯ç”±æ¶æ„æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·ç•Œé¢
    participant JS as å‰ç«¯JS
    participant API as FastAPIåç«¯
    participant RAG as RAGç³»ç»Ÿ
    participant SM as ä¼šè¯ç®¡ç†å™¨
    participant AI as AIç”Ÿæˆå™¨ â­
    participant LR as æ™ºèƒ½è·¯ç”±å™¨ ğŸ†•
    participant R1 as DeepSeek-R1<br/>(æ¨ç†æ¨¡å‹) ğŸ†•
    participant V3 as DeepSeek-V3<br/>(å·¥å…·è°ƒç”¨) ğŸ†•
    participant TM as å·¥å…·ç®¡ç†å™¨
    participant ST as æœç´¢å·¥å…·
    participant VDB as å‘é‡æ•°æ®åº“<br/>(ChromaDB)
    participant Claude as Claude API<br/>(åå¤‡æ”¯æŒ) ğŸ“‹

    Note over U,Claude: V2.0 åŒæ¨¡å‹æ™ºèƒ½è·¯ç”±æ¶æ„ - å®Œæ•´è¯·æ±‚å¤„ç†æµç¨‹

    %% ç”¨æˆ·äº¤äº’é˜¶æ®µ
    U->>JS: ç”¨æˆ·è¾“å…¥æŸ¥è¯¢
    JS->>API: POST /api/query {query, session_id}
    
    %% åç«¯å¤„ç†å…¥å£
    API->>RAG: process_query(query, session_id)
    
    %% ä¼šè¯ç®¡ç†
    RAG->>SM: get_conversation_history(session_id)
    SM-->>RAG: conversation_history
    
    %% å·¥å…·å®šä¹‰å‡†å¤‡ - æ–°å¢å¤šæ ¼å¼æ”¯æŒ
    RAG->>TM: get_tool_definitions_for_provider()
    
    Note over TM: æ ¹æ®é…ç½®æä¾›å•†è¿”å›<br/>OpenAIæ ¼å¼(DeepSeek)æˆ–<br/>Claudeæ ¼å¼å·¥å…·å®šä¹‰
    
    TM-->>RAG: tools (æ ¼å¼é€‚é…)
    
    %% AIç”Ÿæˆ - æ ¸å¿ƒè·¯ç”±é€»è¾‘
    RAG->>AI: generate_response(query, history, tools, tool_manager)
    
    Note over AI: æ£€æµ‹å½“å‰æä¾›å•†é…ç½®<br/>LLM_PROVIDER: "deepseek"
    
    AI->>AI: _generate_deepseek_response()
    
    %% æ ¼å¼è½¬æ¢ - æ–°å¢åŠŸèƒ½
    Note over AI: æ£€æŸ¥å¹¶è½¬æ¢å·¥å…·æ ¼å¼<br/>Claudeâ†’OpenAI (å¦‚éœ€è¦)
    
    %% æ™ºèƒ½è·¯ç”±å†³ç­– - æ ¸å¿ƒåˆ›æ–°
    AI->>LR: call_with_tools() æˆ– call_simple_chat()
    
    alt éœ€è¦å·¥å…·è°ƒç”¨
        Note over LR: ğŸ” æ£€æµ‹åˆ°å·¥å…·è°ƒç”¨éœ€æ±‚<br/>è·¯ç”±è‡³å·¥å…·è°ƒç”¨æ¨¡å‹
        LR->>V3: ä½¿ç”¨ DeepSeek-V3
        Note over V3: ä¸“é—¨å¤„ç†å·¥å…·è°ƒç”¨<br/>å‡½æ•°æ‰§è¡Œèƒ½åŠ›å¼º
        V3-->>LR: å·¥å…·è°ƒç”¨å“åº”
        
        %% å·¥å…·æ‰§è¡Œé˜¶æ®µ
        LR->>TM: æ‰§è¡Œæ£€æµ‹åˆ°çš„å·¥å…·è°ƒç”¨
        TM->>ST: execute_tool(tool_name, **args)
        ST->>VDB: å‘é‡æœç´¢æŸ¥è¯¢
        
        %% å‘é‡æ£€ç´¢æµç¨‹
        Note over VDB: 1. è¯­ä¹‰ç›¸ä¼¼åº¦è®¡ç®—<br/>2. è¿‡æ»¤æ¡ä»¶åº”ç”¨<br/>3. ç›¸å…³æ–‡æ¡£æ£€ç´¢
        
        VDB-->>ST: ç›¸å…³æ–‡æ¡£å’Œå…ƒæ•°æ®
        ST-->>TM: æ ¼å¼åŒ–æœç´¢ç»“æœ
        TM-->>LR: å·¥å…·æ‰§è¡Œç»“æœ
        
        %% æœ€ç»ˆæ¨ç†é˜¶æ®µ - æ™ºèƒ½åˆ‡æ¢
        Note over LR: ğŸ”„ åˆ‡æ¢åˆ°æ¨ç†æ¨¡å‹<br/>è¿›è¡Œç»“æœæ•´åˆ
        LR->>R1: ä½¿ç”¨ DeepSeek-R1 æ•´åˆç»“æœ
        Note over R1: ä¸“é—¨å¤„ç†å¤æ‚æ¨ç†<br/>æ€è€ƒèƒ½åŠ›å¼ºï¼Œé€»è¾‘æ¸…æ™°
        R1-->>LR: æœ€ç»ˆæ•´åˆå“åº”
        
    else çº¯å¯¹è¯æŸ¥è¯¢
        Note over LR: ğŸ’­ æ£€æµ‹åˆ°çº¯å¯¹è¯éœ€æ±‚<br/>ç›´æ¥è·¯ç”±è‡³æ¨ç†æ¨¡å‹
        LR->>R1: ä½¿ç”¨ DeepSeek-R1
        Note over R1: å¤„ç†ä¸€èˆ¬çŸ¥è¯†é—®ç­”<br/>æ— éœ€å·¥å…·è°ƒç”¨
        R1-->>LR: ç›´æ¥å“åº”
    end
    
    %% é”™è¯¯å¤„ç†å’Œåå¤‡æœºåˆ¶
    alt DeepSeek è¯·æ±‚å¤±è´¥
        Note over LR: âš ï¸ DeepSeek API å¼‚å¸¸
        AI->>Claude: é™çº§åˆ° Claude API
        Note over Claude: åå¤‡æ”¯æŒæœºåˆ¶<br/>ç¡®ä¿æœåŠ¡å¯ç”¨æ€§
        Claude-->>AI: Claude å“åº”
    end
    
    LR-->>AI: æœ€ç»ˆå“åº”
    AI-->>RAG: ç”Ÿæˆçš„å›ç­”
    
    %% ä¼šè¯ç®¡ç†å’Œå“åº”
    RAG->>SM: add_interaction(session_id, query, response)
    RAG-->>API: {answer, sources, session_id}
    
    API-->>JS: JSON å“åº”
    JS->>U: æ˜¾ç¤ºå›ç­”å’Œæ¥æº
    
    %% çŠ¶æ€æ›´æ–°
    JS->>API: GET /api/courses (å¯é€‰)
    API-->>JS: è¯¾ç¨‹ç»Ÿè®¡æ›´æ–°
```

## V2.0 æ¶æ„æµç¨‹å¯¹æ¯”åˆ†æ

### å…³é”®æ”¹è¿›ç‚¹æ ‡æ³¨è¯´æ˜:

- **â­ AIç”Ÿæˆå™¨**: é‡æ„æ”¯æŒå¤šæä¾›å•†
- **ğŸ†• æ™ºèƒ½è·¯ç”±å™¨**: å…¨æ–°ç»„ä»¶ï¼Œæ ¸å¿ƒåˆ›æ–°
- **ğŸ†• åŒæ¨¡å‹æ”¯æŒ**: DeepSeek-R1 + DeepSeek-V3
- **ğŸ“‹ Claudeåå¤‡**: ä¿ç•™ä½œä¸ºé™çº§é€‰é¡¹

## æ™ºèƒ½è·¯ç”±å†³ç­–æ ‘

```mermaid
flowchart TD
    A[æ”¶åˆ°ç”¨æˆ·æŸ¥è¯¢] --> B{æ£€æŸ¥å·¥å…·å®šä¹‰}
    B -->|æœ‰å·¥å…·| C[ğŸ¯ å·¥å…·è°ƒç”¨è·¯å¾„]
    B -->|æ— å·¥å…·| D[ğŸ’­ çº¯å¯¹è¯è·¯å¾„]
    
    C --> E[ä½¿ç”¨ DeepSeek-V3<br/>æ‰§è¡Œå·¥å…·è°ƒç”¨]
    E --> F[å·¥å…·æ‰§è¡Œå®Œæˆ]
    F --> G[åˆ‡æ¢åˆ° DeepSeek-R1<br/>æ•´åˆç»“æœæ¨ç†]
    
    D --> H[ç›´æ¥ä½¿ç”¨ DeepSeek-R1<br/>å¤„ç†å¯¹è¯]
    
    G --> I[è¿”å›æœ€ç»ˆå“åº”]
    H --> I
    
    I --> J{è¯·æ±‚æˆåŠŸ?}
    J -->|æ˜¯| K[å®Œæˆå“åº”]
    J -->|å¦| L[é™çº§åˆ° Claude API]
    L --> K
    
    style C fill:#e1f5fe
    style D fill:#f3e5f5
    style E fill:#e8f5e8
    style G fill:#fff3e0
    style H fill:#fff3e0
```

## åŒæ¨¡å‹ååŒå·¥ä½œæœºåˆ¶

### å·¥å…·è°ƒç”¨åœºæ™¯æµç¨‹:
1. **V3æ¨¡å‹æ¥æ”¶**: ç”¨æˆ·æŸ¥è¯¢ + å·¥å…·å®šä¹‰
2. **å·¥å…·è°ƒç”¨å†³ç­–**: V3åˆ†æå¹¶å†³å®šè°ƒç”¨æœç´¢å·¥å…·
3. **å·¥å…·æ‰§è¡Œ**: æœç´¢ç›¸å…³è¯¾ç¨‹å†…å®¹
4. **æ¨¡å‹åˆ‡æ¢**: è‡ªåŠ¨åˆ‡æ¢åˆ°R1æ¨¡å‹
5. **ç»“æœæ•´åˆ**: R1æ¥æ”¶å·¥å…·ç»“æœè¿›è¡Œæ¨ç†æ•´åˆ
6. **æœ€ç»ˆå“åº”**: ç”Ÿæˆå®Œæ•´çš„å¸¦æ¥æºå›ç­”

### çº¯å¯¹è¯åœºæ™¯æµç¨‹:
1. **ç›´æ¥è·¯ç”±**: è¯†åˆ«ä¸ºä¸€èˆ¬çŸ¥è¯†é—®ç­”
2. **R1å¤„ç†**: ä½¿ç”¨æ¨ç†èƒ½åŠ›ç›´æ¥å›ç­”
3. **å¿«é€Ÿå“åº”**: æ— éœ€å·¥å…·è°ƒç”¨çš„é«˜æ•ˆå¤„ç†

## æ€§èƒ½ä¼˜åŒ–ç‰¹æ€§

### è·¯ç”±æ™ºèƒ½åŒ–:
- **ä»»åŠ¡è¯†åˆ«**: è‡ªåŠ¨åˆ¤æ–­æŸ¥è¯¢ç±»å‹
- **æ¨¡å‹é€‰æ‹©**: ä¸ºä»»åŠ¡é€‰æ‹©æœ€ä¼˜æ¨¡å‹
- **èµ„æºä¼˜åŒ–**: é¿å…ä¸å¿…è¦çš„æ¨¡å‹è°ƒç”¨

### æ ¼å¼å…¼å®¹æ€§:
- **è‡ªåŠ¨è½¬æ¢**: Claudeæ ¼å¼â†’OpenAIæ ¼å¼
- **é€æ˜åˆ‡æ¢**: ç”¨æˆ·æ— æ„ŸçŸ¥çš„APIåˆ‡æ¢
- **ç»Ÿä¸€æ¥å£**: å¤šæä¾›å•†ç»Ÿä¸€è°ƒç”¨æ–¹å¼

## é”™è¯¯å¤„ç†å’Œé™çº§æœºåˆ¶

```mermaid
graph TD
    A[è¯·æ±‚å¼€å§‹] --> B{DeepSeekå¯ç”¨?}
    B -->|æ˜¯| C[æ™ºèƒ½è·¯ç”±å¤„ç†]
    B -->|å¦| D[åˆ‡æ¢åˆ°Claude]
    
    C --> E{å¤„ç†æˆåŠŸ?}
    E -->|æ˜¯| F[è¿”å›ç»“æœ]
    E -->|å¦| G[é”™è¯¯é‡è¯•]
    
    G --> H{é‡è¯•æˆåŠŸ?}
    H -->|æ˜¯| F
    H -->|å¦| D
    
    D --> I[Claudeå¤„ç†]
    I --> F
    
    style D fill:#ffebee
    style I fill:#ffebee
```

## é…ç½®é©±åŠ¨æ¶æ„

ç³»ç»Ÿé€šè¿‡ç¯å¢ƒå˜é‡é…ç½®å®ç°åŠ¨æ€åˆ‡æ¢:

```bash
# åŒæ¨¡å‹é…ç½®
LLM_PROVIDER=deepseek
MODEL_REASON=deepseek-ai/DeepSeek-R1      # æ¨ç†ä¸“ç”¨
MODEL_TOOLCALL=deepseek-ai/DeepSeek-V3    # å·¥å…·è°ƒç”¨ä¸“ç”¨

# åå¤‡é…ç½®  
ANTHROPIC_API_KEY=claude_key_here         # Claudeåå¤‡æ”¯æŒ
```

---

**V2.0 æµç¨‹å›¾æ€»ç»“**: é€šè¿‡æ™ºèƒ½è·¯ç”±å™¨å®ç°åŒæ¨¡å‹ååŒå·¥ä½œï¼Œæ ¹æ®ä»»åŠ¡ç±»å‹è‡ªåŠ¨é€‰æ‹©æœ€é€‚åˆçš„AIæ¨¡å‹ï¼Œæ—¢ä¿è¯äº†å·¥å…·è°ƒç”¨çš„å‡†ç¡®æ€§(V3)ï¼Œåˆç¡®ä¿äº†æ¨ç†è¿‡ç¨‹çš„æ·±åº¦(R1)ï¼ŒåŒæ—¶æä¾›Claudeä½œä¸ºåå¤‡ä¿éšœï¼Œå®ç°äº†é«˜å¯ç”¨ã€é«˜æ€§èƒ½çš„RAGç³»ç»Ÿæ¶æ„ã€‚