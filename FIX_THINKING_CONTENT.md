# ä¿®å¤DeepSeek-R1æ¨¡å‹è¾“å‡ºå†…éƒ¨æ€è€ƒå†…å®¹çš„é—®é¢˜

## é—®é¢˜æè¿°
ç”¨æˆ·åœ¨ä½¿ç”¨ç³»ç»Ÿæ—¶ï¼ŒAIå“åº”ä¸­åŒ…å«äº†ä¸åº”è¯¥å±•ç¤ºçš„å†…éƒ¨æ€è€ƒè¿‡ç¨‹ï¼Œå¦‚ï¼š
- "Okay, the user is asking about RAG in the context of course materials..."
- "Looking through the retrieved content..."
- "I need to present this information concisely..."
- "Wait, but the user specifically asked about..."
- "Let me start by recalling what I know..."

è¿™äº›å†…å®¹æ˜¯DeepSeek-R1æ¨¡å‹çš„å†…éƒ¨æ€è€ƒè¿‡ç¨‹ï¼Œä¸åº”è¯¥å±•ç¤ºç»™æœ€ç»ˆç”¨æˆ·ã€‚

## é—®é¢˜åˆ†æ

### 1. æ ¹æœ¬åŸå› 
- **DeepSeek-R1æ¨¡å‹ç‰¹æ€§**ï¼šè¯¥æ¨¡å‹è®¾è®¡æ—¶ä¼šè¾“å‡ºè¯¦ç»†çš„æ€è€ƒè¿‡ç¨‹
- **ç³»ç»Ÿæç¤ºæœªå®Œå…¨ç”Ÿæ•ˆ**ï¼šè™½ç„¶SYSTEM_PROMPTä¸­æ˜ç¡®è¦æ±‚"No meta-commentary"ï¼Œä½†æ¨¡å‹ä»è¾“å‡ºæ€è€ƒå†…å®¹
- **åˆå§‹æ–¹æ¡ˆå±€é™æ€§**ï¼šç®€å•çš„æ¨¡å¼åŒ¹é…æ— æ³•é€‚åº”R1æ¨¡å‹å¤šæ ·çš„æ€è€ƒè¡¨è¾¾æ–¹å¼

### 2. R1æ¨¡å‹å“åº”ç»“æ„åˆ†æ
ç»è¿‡æ·±å…¥åˆ†æï¼Œå‘ç°R1æ¨¡å‹çš„å“åº”æœ‰ä»¥ä¸‹ç»“æ„ç‰¹å¾ï¼š
- **æ€è€ƒéƒ¨åˆ†**ï¼šé€šå¸¸åœ¨å“åº”å¼€å¤´ï¼ŒåŒ…å«ç¬¬ä¸€äººç§°å’Œè¿‡ç¨‹æ€§è¯­è¨€
- **ç­”æ¡ˆéƒ¨åˆ†**ï¼šç»“æ„åŒ–å†…å®¹ï¼Œå¦‚åˆ—è¡¨ã€æ ‡é¢˜ã€æ­£å¼é™ˆè¿°
- **åˆ†ç•Œç‰¹å¾**ï¼šæ€è€ƒå’Œç­”æ¡ˆä¹‹é—´é€šå¸¸æœ‰æ˜ç¡®çš„è½¬æŠ˜æˆ–æ ¼å¼å˜åŒ–

## æœ€ç»ˆè§£å†³æ–¹æ¡ˆ

### å®æ–½çš„æ™ºèƒ½ç»“æ„åŒ–è¿‡æ»¤æ–¹æ³•

ç»è¿‡å¤šæ¬¡è¿­ä»£ä¼˜åŒ–ï¼Œæœ€ç»ˆé‡‡ç”¨äº†**æ™ºèƒ½ç»“æ„åŒ–è¯†åˆ«**æ–¹æ³•ï¼Œè€Œéç®€å•çš„æ¨¡å¼åŒ¹é…ï¼š

#### 1. æ ¸å¿ƒå®ç°æ€è·¯

```python
def _clean_thinking_content(self, response_text: str) -> str:
    """
    æ¸…ç†DeepSeek-R1å“åº”ä¸­çš„æ€è€ƒå†…å®¹
    ä½¿ç”¨æ™ºèƒ½ç»“æ„åŒ–è¯†åˆ«æ–¹æ³•
    """
    if not config.CLEAN_R1_THINKING or not response_text:
        return response_text
    
    # æ­¥éª¤1ï¼šç§»é™¤<thinking>æ ‡ç­¾
    cleaned = re.sub(r'<thinking>.*?</thinking>', '', response_text, flags=re.DOTALL)
    
    # æ­¥éª¤2ï¼šæ™ºèƒ½è¯†åˆ«ç­”æ¡ˆå¼€å§‹ä½ç½®
    answer_markers = [
        "\n\nThe available course materials",
        "\n\nBased on the course materials",
        "\n\n1.",  # ç¼–å·åˆ—è¡¨
        "\n\n**",  # ç²—ä½“æ ‡é¢˜
        "\n\n###", # Markdownæ ‡é¢˜
    ]
    
    # æ‰¾åˆ°ç­”æ¡ˆå¼€å§‹ä½ç½®ï¼Œç›´æ¥è¿”å›ç­”æ¡ˆéƒ¨åˆ†
    for marker in answer_markers:
        pos = cleaned.find(marker)
        if pos != -1:
            return cleaned[pos:].strip()
    
    # æ­¥éª¤3ï¼šåŸºäºè¯­è¨€ç‰¹å¾è¿‡æ»¤
    paragraphs = cleaned.split('\n\n')
    filtered_paragraphs = []
    found_real_answer = False
    
    for para in paragraphs:
        para_lower = para.lower().strip()
        
        # æ£€æµ‹çœŸå®ç­”æ¡ˆçš„å¼€å§‹
        if not found_real_answer:
            if para.startswith(('1.', '**', 'The available', 'Based on')):
                found_real_answer = True
                filtered_paragraphs.append(para)
                continue
        
        # æ‰¾åˆ°ç­”æ¡ˆåï¼Œä¿ç•™æ‰€æœ‰åç»­å†…å®¹
        if found_real_answer:
            filtered_paragraphs.append(para)
            continue
        
        # ç¬¬ä¸€äººç§°æ£€æµ‹ï¼ˆæ€è€ƒå†…å®¹ç‰¹å¾ï¼‰
        if any(ind in para_lower for ind in ['i ', "i'm", "let me", "i need"]):
            continue  # è·³è¿‡æ€è€ƒå†…å®¹
        
        # è¿‡ç¨‹æ€§è¯­è¨€æ£€æµ‹
        if any(word in para_lower for word in ['searching', 'looking', 'checking', 'wait', 'hmm']):
            continue  # è·³è¿‡æ€è€ƒå†…å®¹
        
        # ä¿ç•™éæ€è€ƒå†…å®¹
        filtered_paragraphs.append(para)
    
    return '\n\n'.join(filtered_paragraphs).strip()
```

#### 2. å…³é”®æ”¹è¿›ç‚¹

1. **ç»“æ„åŒ–è¯†åˆ«**ï¼šä¸å†ä¾èµ–ç¡¬ç¼–ç çš„çŸ­è¯­åˆ—è¡¨ï¼Œè€Œæ˜¯è¯†åˆ«ç­”æ¡ˆçš„ç»“æ„ç‰¹å¾
2. **ç­”æ¡ˆæ ‡è®°æ£€æµ‹**ï¼šä¼˜å…ˆå¯»æ‰¾æ˜ç¡®çš„ç­”æ¡ˆå¼€å§‹æ ‡è®°
3. **çŠ¶æ€æœºé€»è¾‘**ï¼šä¸€æ—¦æ‰¾åˆ°çœŸå®ç­”æ¡ˆï¼Œä¿ç•™æ‰€æœ‰åç»­å†…å®¹
4. **è¯­è¨€ç‰¹å¾åˆ†æ**ï¼šåŸºäºç¬¬ä¸€äººç§°å’Œè¿‡ç¨‹æ€§è¯­è¨€è¯†åˆ«æ€è€ƒå†…å®¹

### 3. å®æ–½è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜åŠè§£å†³

#### é—®é¢˜1ï¼šå¯¼å…¥é”™è¯¯
- **é”™è¯¯**ï¼š`attempted relative import with no known parent package`
- **åŸå› **ï¼šåœ¨æ–¹æ³•å†…éƒ¨ä½¿ç”¨ `from config import config` å¯¼è‡´è¿è¡Œæ—¶å¯¼å…¥é”™è¯¯
- **è§£å†³**ï¼šå°† `import re` ç§»åˆ°æ¨¡å—é¡¶éƒ¨ï¼Œåˆ é™¤æ–¹æ³•å†…çš„é‡å¤å¯¼å…¥

#### é—®é¢˜2ï¼šè¿‡åº¦è¿‡æ»¤
- **é—®é¢˜**ï¼šåˆå§‹çš„æ¨¡å¼åŒ¹é…æ–¹æ³•è¿‡äºæ¿€è¿›ï¼Œå¯èƒ½åˆ é™¤æœ‰ç”¨å†…å®¹
- **è§£å†³**ï¼šé‡‡ç”¨çŠ¶æ€æœºé€»è¾‘ï¼Œä¸€æ—¦è¯†åˆ«åˆ°çœŸå®ç­”æ¡ˆå°±ä¿ç•™æ‰€æœ‰åç»­å†…å®¹

#### é—®é¢˜3ï¼šæ¨¡å¼ç»´æŠ¤å›°éš¾
- **é—®é¢˜**ï¼šç¡¬ç¼–ç çš„çŸ­è¯­åˆ—è¡¨éš¾ä»¥ç»´æŠ¤å’Œæ‰©å±•
- **è§£å†³**ï¼šæ”¹ä¸ºåŸºäºè¯­è¨€ç»“æ„ç‰¹å¾çš„æ™ºèƒ½è¯†åˆ«

### 4. é…ç½®ç®¡ç†

åœ¨ `config.py` ä¸­æ·»åŠ äº†é…ç½®å¼€å…³ï¼š

```python
# DeepSeek-R1å“åº”æ¸…ç†é…ç½®
CLEAN_R1_THINKING = os.getenv("CLEAN_R1_THINKING", "true").lower() == "true"
R1_THINKING_MIN_LENGTH = int(os.getenv("R1_THINKING_MIN_LENGTH", "50"))
```

è¿™å…è®¸åœ¨éœ€è¦æ—¶å…³é—­æ¸…ç†åŠŸèƒ½æˆ–è°ƒæ•´æœ€å°é•¿åº¦é˜ˆå€¼ã€‚

## å®æ–½ç»“æœ

### æœ€ç»ˆå®ç°æ•ˆæœ

ç»è¿‡å¤šæ¬¡è¿­ä»£ä¼˜åŒ–ï¼ŒæˆåŠŸå®ç°äº†æ™ºèƒ½çš„æ€è€ƒå†…å®¹è¿‡æ»¤ï¼š

1. **æµ‹è¯•ç»“æœ**
   - âœ… "What is RAG?" - è¿”å›å¹²å‡€çš„RAGå®šä¹‰ï¼Œæ— æ€è€ƒè¿‡ç¨‹
   - âœ… "What are the core principles..." - è¿”å›ç»“æ„åŒ–ç­”æ¡ˆï¼Œè¿‡æ»¤äº†æ‰€æœ‰å†…éƒ¨ç‹¬ç™½
   - âœ… å·¥å…·è°ƒç”¨åœºæ™¯ - æœç´¢ç»“æœæ¸…æ™°ï¼Œæ— è¿‡ç¨‹æè¿°

2. **å…³é”®æˆå°±**
   - ä»ç¡¬ç¼–ç æ¨¡å¼åŒ¹é…å‡çº§åˆ°æ™ºèƒ½ç»“æ„è¯†åˆ«
   - æ”¯æŒå¤šç§ç­”æ¡ˆæ ¼å¼ï¼ˆåˆ—è¡¨ã€æ ‡é¢˜ã€æ®µè½ï¼‰
   - ä¿æŒäº†ç­”æ¡ˆçš„å®Œæ•´æ€§å’Œå‡†ç¡®æ€§
   - ä»£ç å¯ç»´æŠ¤æ€§å¤§å¹…æå‡

### æŠ€æœ¯æ´å¯Ÿ

1. **R1æ¨¡å‹ç‰¹æ€§ç†è§£**
   - R1æ¨¡å‹çš„æ€è€ƒå†…å®¹é€šå¸¸åœ¨å“åº”å¼€å¤´
   - æ€è€ƒå†…å®¹åŒ…å«å¤§é‡ç¬¬ä¸€äººç§°å’Œè¿‡ç¨‹æ€§æè¿°
   - çœŸå®ç­”æ¡ˆé€šå¸¸æœ‰æ˜ç¡®çš„ç»“æ„ç‰¹å¾

2. **è¿‡æ»¤ç­–ç•¥æ¼”è¿›**
   - V1: ç®€å•çš„çŸ­è¯­åŒ¹é…ï¼ˆæ˜“è¯¯åˆ ã€éš¾ç»´æŠ¤ï¼‰
   - V2: æ‰©å±•çš„æ¨¡å¼åˆ—è¡¨ï¼ˆä»æœ‰å±€é™æ€§ï¼‰
   - V3: æ™ºèƒ½ç»“æ„è¯†åˆ«ï¼ˆæœ€ä¼˜æ–¹æ¡ˆï¼‰

3. **å®æ–½ç»éªŒ**
   - æ¨¡å—çº§å¯¼å…¥é¿å…è¿è¡Œæ—¶é”™è¯¯
   - çŠ¶æ€æœºé€»è¾‘ç¡®ä¿ä¸ä¼šè¿‡åº¦è¿‡æ»¤
   - é…ç½®å¼€å…³æä¾›çµæ´»æ€§

## æ–°å‘ç°é—®é¢˜ï¼šåµŒå…¥å¼æ€è€ƒå†…å®¹ï¼ˆ2024-12-19æ›´æ–°ï¼‰

### é—®é¢˜æè¿°
å³ä½¿ç»è¿‡åˆæ­¥ä¼˜åŒ–ï¼Œä»ç„¶å‘ç°å“åº”ä¸­åŒ…å«åµŒå…¥åœ¨æ­£æ–‡å†…éƒ¨çš„æ€è€ƒå†…å®¹ï¼š

#### å®é™…æ¡ˆä¾‹
ç”¨æˆ·æŸ¥è¯¢ï¼š"What are the best practices for prompt engineering?"
å“åº”ä¸­åŒ…å«ï¼š
- "**First, looking at Lesson 5**, it mentions..." - å™è¿°æœç´¢è¿‡ç¨‹
- "**That seems like** a structural best practice..." - ä¸»è§‚åˆ¤æ–­è¡¨è¾¾
- "**So, thinking ahead about** scalability..." - æ˜¾å¼æ€è€ƒè¿‡ç¨‹
- "**Putting this all together**, the best practices..." - æ€»ç»“æ€§æ€è€ƒ

### é—®é¢˜åˆ†æ

#### 1. è¿‡æ»¤ç²’åº¦é—®é¢˜
- **å½“å‰æ–¹æ¡ˆ**ï¼šæ®µè½çº§åˆ«è¿‡æ»¤ï¼ˆ`\n\n`åˆ†å‰²ï¼‰
- **é—®é¢˜**ï¼šæ€è€ƒå†…å®¹åµŒå…¥åœ¨ç­”æ¡ˆæ®µè½å†…éƒ¨ï¼Œæ— æ³•è¢«æ®µè½çº§è¿‡æ»¤æ•è·
- **å½±å“**ï¼šç”¨æˆ·çœ‹åˆ°æ··æ‚ç€å†…éƒ¨æ€è€ƒçš„ç­”æ¡ˆï¼Œå½±å“ä¸“ä¸šæ€§

#### 2. æ¨¡å¼è¦†ç›–ä¸å…¨
å½“å‰æ£€æµ‹é—æ¼äº†ï¼š
- **å™è¿°æ€§å¼€å¤´**ï¼š"First, looking at...", "Now, examining..."
- **ä¸»è§‚åˆ¤æ–­è¯**ï¼š"seems like", "appears to be", "suggests that"
- **è¿‡æ¸¡æ€§è¯­å¥**ï¼š"Putting this together", "All in all"
- **å¼•ç”¨æ€§æè¿°**ï¼š"The lesson mentions", "It talks about"

#### 3. DeepSeek-R1æ¨¡å‹ç‰¹æ€§
- æ¨¡å‹å€¾å‘äºç”Ÿæˆ"æµå¼æ€è€ƒ"ï¼ˆstream of consciousnessï¼‰
- å°†æ¨ç†è¿‡ç¨‹è‡ªç„¶åµŒå…¥åˆ°ç­”æ¡ˆå™è¿°ä¸­
- éš¾ä»¥å®Œå…¨é€šè¿‡æç¤ºè¯æ§åˆ¶

### å¢å¼ºè§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆï¼šå¢å¼ºæ£€æµ‹æ¨¡å¼ï¼ˆå®æ–½ä¸­ï¼‰

1. **æ‰©å±•å…ƒè¯„è®ºæ¨¡å¼åˆ—è¡¨**
```python
meta_comment_patterns = [
    # åŸæœ‰æ¨¡å¼...
    # æ–°å¢å™è¿°æ€§æ¨¡å¼
    "first, looking",
    "now, examining",
    "next, considering",
    # ä¸»è§‚åˆ¤æ–­æ¨¡å¼
    "seems like",
    "appears to",
    "suggests that",
    "might be",
    # è¿‡æ¸¡æ€§æ¨¡å¼
    "putting this",
    "all together",
    "in summary",
    # å¼•ç”¨æè¿°æ¨¡å¼
    "the lesson mentions",
    "it talks about",
    "it mentions",
    "it discusses",
    # æ€è€ƒè¿‡ç¨‹è¯
    "thinking ahead",
    "thinking about",
    "considering this",
]
```

2. **å¥å­çº§åˆ«æ£€æµ‹ï¼ˆæœªæ¥ä¼˜åŒ–ï¼‰**
```python
# å°†æ®µè½æ‹†åˆ†ä¸ºå¥å­
sentences = re.split(r'(?<=[.!?])\s+', paragraph)
filtered_sentences = []
for sentence in sentences:
    if not contains_thinking_pattern(sentence):
        filtered_sentences.append(sentence)
result = ' '.join(filtered_sentences)
```

3. **æ™ºèƒ½å¥å­é‡å†™ï¼ˆé«˜çº§æ–¹æ¡ˆï¼‰**
- æ£€æµ‹åŒ…å«æ€è€ƒçš„å¥å­
- æå–å…¶ä¸­çš„äº‹å®å†…å®¹
- é‡å†™ä¸ºå®¢è§‚é™ˆè¿°

### å®æ–½æ­¥éª¤

1. **ç¬¬ä¸€é˜¶æ®µ**ï¼šå¢å¼ºæ¨¡å¼æ£€æµ‹ï¼ˆå½“å‰ï¼‰
   - æ‰©å±•meta_comment_patternsåˆ—è¡¨
   - æ·»åŠ æ›´å¤šæ€è€ƒæ ‡è®°è¯
   - æé«˜æ£€æµ‹å‡†ç¡®æ€§

2. **ç¬¬äºŒé˜¶æ®µ**ï¼šå¥å­çº§è¿‡æ»¤ï¼ˆè®¡åˆ’ä¸­ï¼‰
   - å®ç°å¥å­åˆ†å‰²é€»è¾‘
   - é€å¥æ£€æµ‹å’Œè¿‡æ»¤
   - ä¿æŒå†…å®¹è¿è´¯æ€§

3. **ç¬¬ä¸‰é˜¶æ®µ**ï¼šæ™ºèƒ½é‡å†™ï¼ˆæœªæ¥ï¼‰
   - ä½¿ç”¨NLPæŠ€æœ¯åˆ†æå¥å­ç»“æ„
   - æå–äº‹å®ä¿¡æ¯
   - ç”Ÿæˆå®¢è§‚è¡¨è¿°

## åç»­å»ºè®®

1. **ç›‘æ§å’Œä¼˜åŒ–**
   - æ”¶é›†æ›´å¤šR1å“åº”æ ·æœ¬ï¼ŒæŒç»­ä¼˜åŒ–è¯†åˆ«ç®—æ³•
   - è€ƒè™‘ä½¿ç”¨æœºå™¨å­¦ä¹ æ–¹æ³•è‡ªåŠ¨è¯†åˆ«æ€è€ƒ/ç­”æ¡ˆè¾¹ç•Œ
   - æ·»åŠ æ€§èƒ½ç›‘æ§ï¼Œç¡®ä¿è¿‡æ»¤ä¸å½±å“å“åº”é€Ÿåº¦

2. **æ‰©å±•æ”¯æŒ**
   - é€‚é…å…¶ä»–å¯èƒ½è¾“å‡ºæ€è€ƒå†…å®¹çš„æ¨¡å‹
   - æ”¯æŒæµå¼å“åº”çš„å®æ—¶è¿‡æ»¤
   - æä¾›ç”¨æˆ·çº§åˆ«çš„è¿‡æ»¤åå¥½è®¾ç½®

3. **é•¿æœŸæ–¹æ¡ˆ**
   - ä¸æ¨¡å‹æä¾›æ–¹æ²Ÿé€šï¼Œè¯·æ±‚æä¾›åŸç”Ÿçš„æ€è€ƒå†…å®¹åˆ†ç¦»
   - æ¢ç´¢ä½¿ç”¨ä¸“é—¨çš„åå¤„ç†æ¨¡å‹
   - ç ”ç©¶æ›´é«˜çº§çš„NLPæŠ€æœ¯è¿›è¡Œå†…å®¹åˆ†ç±»

---

**æœ€åæ›´æ–°**ï¼š2024-12-19ï¼ˆç¬¬äºŒæ¬¡ä¼˜åŒ–ï¼‰
**å®æ–½çŠ¶æ€**ï¼šğŸ”„ æŒç»­ä¼˜åŒ–ä¸­
**å½±å“èŒƒå›´**ï¼šæ‰€æœ‰ä½¿ç”¨DeepSeek-R1æ¨¡å‹çš„å“åº”
**æ€§èƒ½å½±å“**ï¼šå¯å¿½ç•¥ï¼ˆ< 10msï¼‰